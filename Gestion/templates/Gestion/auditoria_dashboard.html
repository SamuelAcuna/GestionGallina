{% extends 'Gestion/base.html' %}
{% load humanize l10n %}

{% block title %}{{ title }} - SGA{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ title }}</h1>

    <form method="get" class="d-flex align-items-center gap-2">
        <select name="month" class="form-select form-select-sm" onchange="this.form.submit()">
            {% for m in months %}
            <option value="{{ m }}" {% if m == current_month %}selected{% endif %}>Mes {{ m }}</option>
            {% endfor %}
        </select>
        <select name="year" class="form-select form-select-sm" onchange="this.form.submit()">
            {% for y in years %}
            <option value="{{ y|unlocalize }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-sm btn-outline-secondary"><i class="bi bi-filter"></i> Filtrar</button>
    </form>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-success text-white shadow-sm h-100">
            <div class="card-body">
                <h6 class="card-title text-white-50">Total Ventas</h6>
                <h3 class="fw-bold">$ {{ total_ventas|floatformat:0|intcomma }}</h3>
                <i class="bi bi-graph-up position-absolute top-0 end-0 m-3 fs-1 opacity-25"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-danger text-white shadow-sm h-100">
            <div class="card-body">
                <h6 class="card-title text-white-50">Total Gastos/Compras</h6>
                <h3 class="fw-bold">$ {{ total_compras|floatformat:0|intcomma }}</h3>
                <i class="bi bi-cart-x position-absolute top-0 end-0 m-3 fs-1 opacity-25"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card {% if balance >= 0 %}bg-primary{% else %}bg-dark{% endif %} text-white shadow-sm h-100">
            <div class="card-body">
                <h6 class="card-title text-white-50">Balance del Periodo</h6>
                <h3 class="fw-bold">$ {{ balance|floatformat:0|intcomma }}</h3>
                <i class="bi bi-piggy-bank position-absolute top-0 end-0 m-3 fs-1 opacity-25"></i>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Table -->
<div class="card shadow-sm">
    <div class="card-header bg-light">
        <h5 class="mb-0">Detalle de Movimientos</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Entidad</th>
                        <th>Documento</th>
                        <th>Método</th>
                        <th class="text-end">Monto Total</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in transacciones %}
                    <tr>
                        <td>#{{ t.pk }}</td>
                        <td>{{ t.fecha|date:"d/m/Y" }}</td>
                        <td>
                            {% if t.tipo_operacion == 'COMPRA' %}
                            <span class="badge bg-danger bg-opacity-10 text-danger">GASTO/COMPRA</span>
                            {% else %}
                            <span class="badge bg-success bg-opacity-10 text-success">VENTA</span>
                            {% endif %}
                        </td>
                        <td>{{ t.entidad.nombre_razon_social }}</td>
                        <td><small>{{ t.numero_documento|default:"-" }}</small></td>
                        <td><small>{{ t.metodo_pago|default:"-" }}</small></td>
                        <td
                            class="text-end fw-bold {% if t.tipo_operacion == 'COMPRA' %}text-danger{% else %}text-success{% endif %}">
                            $ {{ t.monto_total|floatformat:0|intcomma }}
                        </td>
                        <td>
                            <a href="{% url 'transaccion-detail' t.pk %}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">No hay movimientos registrados en este
                            periodo.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}